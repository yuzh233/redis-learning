---
title: Redisåº”ç”¨ â€” Scan
date: 2020-02-20
toc: true
tag: redis
category:
    - è¯»ä¹¦ç¬”è®°
    - NoSql
thumbnail: http://img.yuzh.xyz/20200322225703_Pzr10J_woman-leaning-on-white-fence-1974185.jpeg
---

# keys çš„é—®é¢˜
ç”±äºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œkeys å‘½ä»¤ä¸èƒ½éšä¾¿ä½¿ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨ redis çš„å®ä¾‹æœ‰æˆåƒä¸Šä¸‡ä¸ªçš„æ—¶å€™ï¼Œä½¿ç”¨ keys ä¼šå…¨é‡éå†å¯¼è‡´é˜»å¡å…¶ä»–çº¿ç¨‹é€ æˆçº¿ä¸Šä¸šåŠ¡å¡é¡¿ã€‚

<!-- more -->

```sh
127.0.0.1:6379> set codehole1 a
OK
127.0.0.1:6379> set codehole2 b
OK
127.0.0.1:6379> set codehole3 c
OK
127.0.0.1:6379> set code1hole a
OK
127.0.0.1:6379> set code2hole b
OK
127.0.0.1:6379> set code3hole c
OK
127.0.0.1:6379> keys *
1) "code2hole"
2) "codehole2"
3) "code1hole"
4) "codehole1"
5) "code3hole"
6) "company"
7) "codehole3"
127.0.0.1:6379> keys codehole*
1) "codehole2"
2) "codehole1"
3) "codehole3"
127.0.0.1:6379> keys code*hole
1) "code2hole"
2) "code1hole"
3) "code3hole"
127.0.0.1:6379>
```

ã€keys çš„ç¼ºé™·ã€‘

1. æ²¡æœ‰ offsetã€limit å‚æ•°ï¼Œä¸€æ¬¡æ€§åå‡ºæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ keyï¼Œå¦‚æœå®ä¾‹ä¸­æœ‰å‡ ç™¾ä¸‡ä¸ª key æ»¡è¶³æ¡ä»¶ï¼Œå°†ä¼šæ˜¯æ»¡å±çš„å­—ç¬¦ä¸²åˆ·å±ï¼›
2. keys ç®—æ³•æ˜¯éå†ç®—æ³•ï¼Œå¤æ‚åº¦æ˜¯ O(n)ï¼Œå¦‚æœå®ä¾‹ä¸­æœ‰åƒä¸‡çº§çš„ keyï¼Œè¿™ä¸ªæŒ‡ä»¤ä¼šå¯¼è‡´ redis æœåŠ¡å¡é¡¿ï¼Œæ‰€æœ‰è¯»å†™ redis çš„å…¶ä»–æŒ‡ä»¤éƒ½ä¼šè¢«å»¶åç”šè‡³è¶…æ—¶æŠ¥é”™ï¼Œå› ä¸º redis æ˜¯å•çº¿ç¨‹ï¼Œé¡ºåºæ‰§è¡Œæ‰€æœ‰æŒ‡ä»¤ï¼Œå…¶ä»–æŒ‡ä»¤å¿…é¡»ç­‰åˆ°å½“å‰çš„ keys æŒ‡ä»¤æ‰§è¡Œå®Œæ‰èƒ½ç»§ç»­ã€‚

ã€scan çš„ç‰¹ç‚¹ã€‘

ä¸ºäº†è§£å†³ keys å­˜åœ¨çš„é—®é¢˜ï¼Œredis2.8 å¼•å…¥äº† scan æŒ‡ä»¤ï¼š

1. å¤æ‚åº¦ä¹Ÿæ˜¯ O(n)ï¼Œä½†å®ƒæ˜¯é€šè¿‡æ¸¸æ ‡åˆ†æ­¥è¿›è¡Œçš„ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹ï¼›
2. æä¾› limit å‚æ•°ï¼Œå¯ä»¥æ§åˆ¶æ¯æ¬¡è¿”å›çš„æœ€å¤§æ¡æ•°ï¼Œæ³¨æ„ï¼šlimit åªæ˜¯ä¸€ä¸ªç•¥ä¼°å€¼ï¼Œå®é™…è¿”å›çš„ç»“æœå¯å¤šå¯å°‘ï¼›
3. å’Œ keys ä¸€æ ·ï¼Œä¹Ÿæ”¯æŒæ¨¡å¼åŒ¹é…åŠŸèƒ½ï¼›
4. è¿”å›çš„ç»“æœå¯èƒ½ä¼šæœ‰é‡å¤ï¼Œéœ€è¦å®¢æˆ·ç«¯å»é‡ï¼›
5. éå†çš„è¿‡ç¨‹ä¸­å¦‚æœæœ‰æ•°æ®çš„ä¿®æ”¹ï¼Œæ”¹åŠ¨åçš„æ•°æ®ä¸ç¡®ä¿èƒ½éå†åˆ°ï¼›
6. å•æ¬¡è¿”å›çš„ç»“æœæ˜¯ç©ºä¸ä»£è¡¨éå†ç»“æŸï¼Œè¦çœ‹æ¸¸æ ‡çš„è¿”å›å€¼æ˜¯å¦ä¸º 0ã€‚

# scan åŸºæœ¬ç”¨æ³•
> **scan cursor** [MATCH pattern] [COUNT count]

- cursorï¼šæ¸¸æ ‡æ•´æ•°å€¼ï¼Œé¦–æ¬¡éå†ä» 0 å¼€å§‹ï¼Œç›´åˆ°è¿”å›ç»“æœä¸º 0 è¡¨ç¤ºéå†ç»“æŸï¼›
- MATCH patternï¼šåŒ¹é…æ¨¡å¼
- COUNT countï¼šéå†çš„ limit

ä»ä»¥ä¸‹è¾“å‡ºå¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶æŒ‡å®šäº† count ä¸º 1000ï¼Œä½†æ˜¯æ¯æ¬¡è¿”å›éƒ½åªæœ‰åä¸ªå·¦å³ï¼Œæ˜¯å› ä¸ºè¿™é‡Œçš„ count ä¸æ˜¯æŒ‡å®šè¿”å›ç»“æœçš„æ•°é‡ï¼Œè€Œæ˜¯é™å®š **å•æ¬¡éå†çš„å­—å…¸æ§½ä½æ•°é‡**ã€‚

```sh
127.0.0.1:6379> scan 0 match key99* count 1000
1) "10904"
2) 1) "key9952"
   2) "key999"
   3) "key9923"
   4) "key9964"
   5) "key9941"
   6) "key9903"
   7) "key9924"
   8) "key9986"
   9) "key9926"
127.0.0.1:6379> scan 10904 match key99* count 1000
1) "10828"
2)  1) "key9944"
    2) "key9988"
    3) "key9948"
    4) "key9906"
    5) "key9946"
    6) "key9955"
    7) "key9951"
    8) "key9910"
    9) "key994"
   10) "key9954"
   11) "key9992"
   12) "key9967"
127.0.0.1:6379> scan 10828 match key99* count 1000
1) "14802"
2)  1) "key9947"
    2) "key9990"
    3) "key9932"
    4) "key9975"
    5) "key9962"
    6) "key9933"
    7) "key9928"
    8) "key9991"
    9) "key9953"
   10) "key9930"
   11) "key9949"
   12) "key9968"
127.0.0.1:6379>
```

# å­—å…¸çš„ç»“æ„
redis ä¸­çš„æ‰€æœ‰ key éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªå¾ˆå¤§çš„å­—å…¸ä¸­ï¼Œè¿™ä¸ªå­—å…¸çš„ç»“æ„å’Œ HashMap ä¸€æ ·ï¼Œæ˜¯ä¸ª `ä¸€ç»´æ•°ç»„+é“¾è¡¨` çš„ç»“æ„ï¼Œå¦‚å›¾ï¼š

![æ­¤å¤„å€Ÿç”¨ä½œè€…å¤§å¤§çš„å›¾ğŸ˜](http://img.yuzh.xyz/20200220121826_NdeNP2_Screenshot.png)

scan æŒ‡ä»¤è¿”å›çš„æ¸¸æ ‡å°±æ˜¯ä¸€ç»´æ•°ç»„çš„ä½ç½®ç´¢å¼•ï¼Œè¿™ä¸ªä½ç½®ç§°ä¹‹ä¸ºã€Œæ§½slotã€ï¼Œå¦‚æœä¸è€ƒè™‘å­—å…¸çš„æ‰©å®¹ç¼©å®¹ï¼Œç›´æ¥æŒ‰æ•°ç»„ä¸‹è¡¨æŒ¨ä¸ªéå†å°±è¡Œäº†ã€‚count å‚æ•°è¡¨ç¤ºè¦éå†çš„æ§½ä½æ•°ï¼Œä¹‹æ‰€ä»¥è¿”å›çš„ç»“æœå¯å¤šå¯å°‘ï¼Œæ˜¯å› ä¸ºä¸æ˜¯æ‰€æœ‰çš„æ§½ä½ä¸Šéƒ½ä¼šæŒ‚è½½é“¾è¡¨ï¼Œé“¾è¡¨çš„æŒ‚è½½æ•°é‡å¯èƒ½ä¼šæœ‰å¤šä¸ªã€‚æ¯ä¸€æ¬¡éå†éƒ½ä¼šå°† count æ•°é‡ä¸Šçš„æ§½ä½ä¸ŠæŒ‚è½½çš„æ‰€æœ‰é“¾è¡¨å…ƒç´ è¿›è¡Œæ¨¡å¼åŒ¹é…åè¿‡æ»¤åï¼Œä¸€æ¬¡æ€§è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

# å…¶ä»– scan æŒ‡ä»¤
scan ä¸å•èƒ½éå†æ‰€æœ‰çš„ keyï¼Œè¿˜èƒ½éå†æŒ‡å®šç±»å‹çš„ keyã€‚zsan éå† zsetï¼Œhscan éå† hashï¼Œsscan éå† setã€‚

# å¤§ key æ‰«æ
åœ¨ redis çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œè¦å°½é‡é¿å…å¤§ key äº§ç”Ÿã€‚æŸä¸ª key å¤ªå¤§ä¼šç»™æ•°æ®è¿ç§»å¸¦æ¥å¾ˆå¤§çš„é—®é¢˜ï¼Œå¤§ key çš„æ‰©å®¹æ—¶ä¼šç”³è¯·æ›´å¤§çš„å†…å­˜ï¼Œé€ æˆå¡é¡¿ã€‚

å¦‚æœ redis çš„å†…å­˜å¤§èµ·å¤§è½ï¼Œææœ‰å¯èƒ½æ˜¯å› ä¸ºå¤§ key å¯¼è‡´çš„ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦å®šä½åˆ°å…·ä½“æ˜¯å“ªä¸ª keyï¼Œåšè¿›ä¸€æ­¥çš„å¤„ç†ã€‚å¯¹äºå®šä½çº¿ä¸Šçš„å¤§ keyï¼Œredis å®˜æ–¹æä¾›äº†æŒ‡ä»¤ï¼š

> redis-cli -h localhost -p 6379 --bigkeys

```sh
root@1dc111191659:/data# redis-cli -h localhost -p 6379 --bigkeys

# Scanning the entire keyspace to find biggest keys as well as
# average sizes per key type.  You can use -i 0.1 to sleep 0.1 sec
# per 100 SCAN commands (not usually needed).

[00.00%] Biggest string found so far 'key9439' with 4 bytes
[16.37%] Biggest zset   found so far 'company' with 5 members

-------- summary -------

Sampled 10007 keys in the keyspace!
Total key length in bytes is 68951 (avg len 6.89)

Biggest string found 'key9439' has 4 bytes
Biggest   zset found 'company' has 5 members

0 lists with 0 items (00.00% of keys, avg size 0.00)
0 hashs with 0 fields (00.00% of keys, avg size 0.00)
10006 strings with 38896 bytes (99.99% of keys, avg size 3.89)
0 streams with 0 entries (00.00% of keys, avg size 0.00)
0 sets with 0 members (00.00% of keys, avg size 0.00)
1 zsets with 5 members (00.01% of keys, avg size 5.00)
root@1dc111191659:/data#
```
